<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel - Lyra Beauty</title>
  <link rel="stylesheet" href="/style.css">
  <style>
    .payment-status-info {
      background-color: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
    }
    
    .payment-summary p {
      margin: 8px 0;
    }
    
    .payment-completed {
      color: #28a745;
    }
    
    .payment-pending {
      color: #fd7e14;
    }
    
    .payment-failed {
      color: #dc3545;
    }
    
    .payment-details {
      margin-top: 10px;
    }
    
    .payment-details summary {
      cursor: pointer;
      font-weight: bold;
      padding: 5px 0;
    }
    
    .payment-transaction {
      background-color: #ffffff;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 10px;
      margin: 8px 0;
    }
    
    .payment-transaction p {
      margin: 4px 0;
    }
    
    .status-completed {
      color: #28a745;
      font-weight: bold;
    }
    
    .status-pending, .status-processing {
      color: #fd7e14;
      font-weight: bold;
    }
    
    .status-failed {
      color: #dc3545;
      font-weight: bold;
    }
    
    .error-message {
      color: #dc3545;
      font-style: italic;
    }
    
    .appointment-card {
      margin-bottom: 20px;
    }
  </style>
</head>
<body class="gold-bg">
  <div class="container">
    <h2>Admin Panel</h2>
    <p>Welcome, <%= user.username %> (Admin)!</p>
    
    <!-- Navigation Tabs -->
    <div class="admin-nav">
      <button class="nav-tab active" onclick="showTab('appointments')">Appointments</button>
      <button class="nav-tab" onclick="showTab('services')">Service Management</button>
    </div>
    
    <!-- Appointments Tab -->
    <div id="appointments-tab" class="tab-content active">
      <h3>All Appointments</h3>
    <% if (appointments.length > 0) { %>
      <div class="appointments-list">
        <% appointments.forEach(appointment => { %>
          <div class="appointment-card">
            <h4>
              <% if (appointment.firstName || appointment.lastName) { %>
                <%= appointment.firstName %> <%= appointment.lastName %>
              <% } else { %>
                <%= appointment.username %>
              <% } %>
              <% if (appointment.email) { %>
                (<%= appointment.email %>)
              <% } %>
              - <%= appointment.serviceInfo ? appointment.serviceInfo.name : appointment.service %>
            </h4>
            <p><strong>Date:</strong> <%= moment(appointment.date).format('MMMM Do, YYYY') %></p>
            <p><strong>Time:</strong> <%= appointment.time %></p>
            <p><strong>Status:</strong> <%= appointment.status %></p>
            
            <!-- Enhanced Payment Status Information for Admin -->
            <% if (appointment.paymentSummary) { %>
              <div class="payment-status-info">
                <h4>Payment Status</h4>
                <div class="payment-summary">
                  <% if (appointment.paymentSummary.totalPaid > 0) { %>
                    <p class="payment-completed">
                      <strong>✓ Paid:</strong> $<%= (appointment.paymentSummary.totalPaid / 100).toFixed(2) %>
                    </p>
                  <% } %>
                  
                  <% if (appointment.paymentSummary.totalPending > 0) { %>
                    <p class="payment-pending">
                      <strong>⏳ Pending:</strong> $<%= (appointment.paymentSummary.totalPending / 100).toFixed(2) %>
                    </p>
                  <% } %>
                  
                  <% if (appointment.paymentSummary.totalFailed > 0) { %>
                    <p class="payment-failed">
                      <strong>❌ Failed:</strong> $<%= (appointment.paymentSummary.totalFailed / 100).toFixed(2) %>
                    </p>
                  <% } %>
                  
                  <!-- Payment Details for Admin -->
                  <% if (appointment.paymentSummary.paymentDetails && appointment.paymentSummary.paymentDetails.length > 0) { %>
                    <details class="payment-details">
                      <summary>Payment Transaction Details</summary>
                      <div class="payment-transactions">
                        <% appointment.paymentSummary.paymentDetails.forEach(payment => { %>
                          <div class="payment-transaction">
                            <p><strong>Type:</strong> <%= payment.type.replace('_', ' ').toUpperCase() %></p>
                            <p><strong>Amount:</strong> $<%= (payment.amount / 100).toFixed(2) %></p>
                            <p><strong>Status:</strong> 
                              <span class="status-<%= payment.status %>"><%= payment.status.toUpperCase() %></span>
                            </p>
                            <% if (payment.square_payment_id) { %>
                              <p><strong>Square Payment ID:</strong> <%= payment.square_payment_id %></p>
                            <% } %>
                            <% if (payment.error_message) { %>
                              <p class="error-message"><strong>Error:</strong> <%= payment.error_message %></p>
                            <% } %>
                            <% if (payment.retry_count && payment.retry_count > 0) { %>
                              <p><strong>Retry Count:</strong> <%= payment.retry_count %></p>
                            <% } %>
                            <p><small>Created: <%= moment(payment.created_at).format('MMM Do, YYYY HH:mm') %></small></p>
                            <% if (payment.updated_at && payment.updated_at !== payment.created_at) { %>
                              <p><small>Updated: <%= moment(payment.updated_at).format('MMM Do, YYYY HH:mm') %></small></p>
                            <% } %>
                          </div>
                        <% }); %>
                      </div>
                    </details>
                  <% } %>
                </div>
              </div>
            <% } else if (appointment.paidAmount) { %>
              <!-- Legacy Payment Info (fallback) -->
              <div class="payment-info">
                <p><strong>Amount Paid:</strong> $<%= (appointment.paidAmount / 100).toFixed(2) %></p>
                <% if (appointment.paymentId) { %>
                  <p><strong>Payment ID:</strong> <%= appointment.paymentId %></p>
                <% } %>
              </div>
            <% } %>
          </div>
        <% }); %>
      </div>
    <% } else { %>
      <p>No appointments scheduled.</p>
    <% } %>
    </div>
    
    <!-- Services Tab -->
    <div id="services-tab" class="tab-content" style="display: none;">
      <h3>Service Management</h3>
      
      <!-- Add New Service Button -->
      <button class="btn btn-primary" onclick="showAddServiceForm()">Add New Service</button>
      
      <!-- Add Service Form (initially hidden) -->
      <div id="add-service-form" class="form-container" style="display: none;">
        <h4>Add New Service</h4>
        <form id="service-form">
          <div class="form-group">
            <label for="service_key">Service Key:</label>
            <input type="text" id="service_key" name="service_key" required 
                   placeholder="e.g., microblading" pattern="[a-zA-Z0-9_]+"
                   title="Only letters, numbers, and underscores allowed">
          </div>
          
          <div class="form-group">
            <label for="name">Service Name:</label>
            <input type="text" id="name" name="name" required placeholder="e.g., Microblading">
          </div>
          
          <div class="form-group">
            <label for="price">Price ($):</label>
            <input type="number" id="price" name="price" required min="0" max="10000" step="0.01" placeholder="350.00">
          </div>
          
          <div class="form-group">
            <label for="duration_minutes">Duration (minutes):</label>
            <input type="number" id="duration_minutes" name="duration_minutes" min="15" max="480" placeholder="120">
          </div>
          
          <div class="form-group">
            <label for="description">Description:</label>
            <textarea id="description" name="description" rows="3" placeholder="Service description..."></textarea>
          </div>
          
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Save Service</button>
            <button type="button" class="btn btn-secondary" onclick="hideServiceForm()">Cancel</button>
          </div>
        </form>
      </div>
      
      <!-- Services List -->
      <div id="services-list" class="services-list">
        <p>Loading services...</p>
      </div>
      
      <!-- Edit Service Modal (initially hidden) -->
      <div id="edit-service-modal" class="modal" style="display: none;">
        <div class="modal-content">
          <span class="close" onclick="hideEditServiceModal()">&times;</span>
          <h4>Edit Service</h4>
          <form id="edit-service-form">
            <input type="hidden" id="edit-service-id" name="id">
            
            <div class="form-group">
              <label for="edit-service_key">Service Key:</label>
              <input type="text" id="edit-service_key" name="service_key" required 
                     pattern="[a-zA-Z0-9_]+" title="Only letters, numbers, and underscores allowed">
            </div>
            
            <div class="form-group">
              <label for="edit-name">Service Name:</label>
              <input type="text" id="edit-name" name="name" required>
            </div>
            
            <div class="form-group">
              <label for="edit-price">Price ($):</label>
              <input type="number" id="edit-price" name="price" required min="0" max="10000" step="0.01">
            </div>
            
            <div class="form-group">
              <label for="edit-duration_minutes">Duration (minutes):</label>
              <input type="number" id="edit-duration_minutes" name="duration_minutes" min="15" max="480">
            </div>
            
            <div class="form-group">
              <label for="edit-description">Description:</label>
              <textarea id="edit-description" name="description" rows="3"></textarea>
            </div>
            
            <div class="form-group">
              <label>
                <input type="checkbox" id="edit-active" name="active"> Active
              </label>
            </div>
            
            <div class="form-actions">
              <button type="submit" class="btn btn-primary">Update Service</button>
              <button type="button" class="btn btn-secondary" onclick="hideEditServiceModal()">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    
    <a href="/dashboard">User Dashboard</a> | <a href="/logout">Logout</a>
  </div>

  <!-- JavaScript for service management -->
  <script src="/js/admin-services.js"></script>
  <script>
    // Tab navigation
    function showTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.display = 'none';
        tab.classList.remove('active');
      });
      
      // Remove active class from all nav buttons
      document.querySelectorAll('.nav-tab').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Show selected tab
      document.getElementById(tabName + '-tab').style.display = 'block';
      document.getElementById(tabName + '-tab').classList.add('active');
      
      // Add active class to clicked button
      event.target.classList.add('active');
      
      // Load services if services tab is selected
      if (tabName === 'services') {
        loadServices();
      }
    }
  </script>
</body>
</html>
