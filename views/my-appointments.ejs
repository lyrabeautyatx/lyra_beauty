<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Appointments - Lyra Beauty</title>
  <link rel="stylesheet" href="/style.css">
  <style>
    .payment-status-info {
      background-color: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
    }
    
    .payment-summary p {
      margin: 8px 0;
    }
    
    .payment-completed {
      color: #28a745;
    }
    
    .payment-pending {
      color: #fd7e14;
    }
    
    .payment-failed {
      color: #dc3545;
    }
    
    .payment-details {
      margin-top: 10px;
    }
    
    .payment-details summary {
      cursor: pointer;
      font-weight: bold;
      padding: 5px 0;
    }
    
    .payment-transaction {
      background-color: #ffffff;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 10px;
      margin: 8px 0;
    }
    
    .payment-transaction p {
      margin: 4px 0;
    }
    
    .status-completed {
      color: #28a745;
      font-weight: bold;
    }
    
    .status-pending, .status-processing {
      color: #fd7e14;
      font-weight: bold;
    }
    
    .status-failed {
      color: #dc3545;
      font-weight: bold;
    }
    
    .error-message {
      color: #dc3545;
      font-style: italic;
    }
  </style>
</head>
<body class="gold-bg">
  <div class="container">
    <h2>My Appointments</h2>
    

    <% const upcoming = appointments.filter(a => a.status !== 'completed' && a.status !== 'cancelled'); %>
    <% const history = appointments.filter(a => a.status === 'completed' || a.status === 'cancelled'); %>

    <% if (upcoming.length > 0) { %>
      <h4>Upcoming Appointments</h4>
      <div class="appointments-list">
        <% upcoming.forEach(appointment => { %>
          <div class="appointment-card">
            <h3><%= appointment.serviceInfo ? appointment.serviceInfo.name : appointment.service %></h3>
            <p><strong>Date:</strong> <%= moment(appointment.date).format('MMMM Do, YYYY') %></p>
            <p><strong>Time:</strong> <%= appointment.time %></p>
            <p><strong>Status:</strong> <%= appointment.status %></p>
            
            <!-- Enhanced Payment Status Information -->
            <% if (appointment.paymentSummary) { %>
              <div class="payment-status-info">
                <h4>Payment Status</h4>
                <div class="payment-summary">
                  <% if (appointment.paymentSummary.totalPaid > 0) { %>
                    <p class="payment-completed">
                      <strong>✓ Paid:</strong> $<%= (appointment.paymentSummary.totalPaid / 100).toFixed(2) %>
                    </p>
                  <% } %>
                  
                  <% if (appointment.paymentSummary.totalPending > 0) { %>
                    <p class="payment-pending">
                      <strong>⏳ Pending:</strong> $<%= (appointment.paymentSummary.totalPending / 100).toFixed(2) %>
                    </p>
                  <% } %>
                  
                  <% if (appointment.paymentSummary.totalFailed > 0) { %>
                    <p class="payment-failed">
                      <strong>❌ Failed:</strong> $<%= (appointment.paymentSummary.totalFailed / 100).toFixed(2) %>
                    </p>
                  <% } %>
                  
                  <!-- Payment Details -->
                  <% if (appointment.paymentSummary.paymentDetails && appointment.paymentSummary.paymentDetails.length > 0) { %>
                    <details class="payment-details">
                      <summary>Payment Details</summary>
                      <div class="payment-transactions">
                        <% appointment.paymentSummary.paymentDetails.forEach(payment => { %>
                          <div class="payment-transaction">
                            <p><strong>Type:</strong> <%= payment.type.replace('_', ' ').toUpperCase() %></p>
                            <p><strong>Amount:</strong> $<%= (payment.amount / 100).toFixed(2) %></p>
                            <p><strong>Status:</strong> 
                              <span class="status-<%= payment.status %>"><%= payment.status.toUpperCase() %></span>
                            </p>
                            <% if (payment.square_payment_id) { %>
                              <p><strong>Payment ID:</strong> <%= payment.square_payment_id %></p>
                            <% } %>
                            <% if (payment.error_message) { %>
                              <p class="error-message"><strong>Error:</strong> <%= payment.error_message %></p>
                            <% } %>
                            <p><small>Created: <%= moment(payment.created_at).format('MMM Do, YYYY HH:mm') %></small></p>
                          </div>
                        <% }); %>
                      </div>
                    </details>
                  <% } %>
                </div>
              </div>
            <% } else if (appointment.paymentType && appointment.paymentStatus) { %>
              <div class="payment-info">
                <h4>Payment Information</h4>
                <p><strong>Payment Type:</strong> <%= appointment.paymentType.replace('_', ' ').toUpperCase() %></p>
                <p><strong>Payment Status:</strong> <%= appointment.paymentStatus.replace('_', ' ').toUpperCase() %></p>
                <% if (appointment.totalAmount) { %>
                  <p><strong>Total Amount:</strong> $<%= (appointment.totalAmount / 100).toFixed(2) %></p>
                <% } %>
                <% if (appointment.paidAmount) { %>
                  <p><strong>Amount Paid:</strong> $<%= (appointment.paidAmount / 100).toFixed(2) %></p>
                <% } %>
                <% if (appointment.remainingAmount && appointment.remainingAmount > 0) { %>
                  <p><strong>Remaining Balance:</strong> $<%= (appointment.remainingAmount / 100).toFixed(2) %></p>
                  <% if (appointment.paymentData && appointment.paymentData.invoiceId) { %>
                    <p><strong>Invoice ID:</strong> <%= appointment.paymentData.invoiceId %></p>
                  <% } %>
                <% } %>
                <% if (appointment.paymentData && appointment.paymentData.paymentId) { %>
                  <p><strong>Payment ID:</strong> <%= appointment.paymentData.paymentId %></p>
                <% } %>
              </div>
            <% } else if (appointment.paidAmount) { %>
              <p><strong>Amount Paid:</strong> $<%= (appointment.paidAmount / 100).toFixed(2) %></p>
            <% } %>
            <% if (appointment.status !== 'cancelled' && appointment.status !== 'completed') { %>
              <form action="/appointments/<%= appointment.id %>/cancel" method="POST" style="margin-top:1rem;">
                <button type="submit" class="btn btn-danger">Cancel Appointment</button>
              </form>
            <% } %>
          </div>
        <% }); %>
      </div>
    <% } else { %>
      <p>You have no upcoming appointments scheduled.</p>
      <a href="/book" class="btn btn-primary">Book Your First Appointment</a>
    <% } %>

    <% if (history.length > 0) { %>
      <h4 style="margin-top:2rem;">Appointment History</h4>
      <div class="appointments-list">
        <% history.forEach(appointment => { %>
          <div class="appointment-card">
            <h3><%= appointment.serviceInfo ? appointment.serviceInfo.name : appointment.service %></h3>
            <p><strong>Date:</strong> <%= moment(appointment.date).format('MMMM Do, YYYY') %></p>
            <p><strong>Time:</strong> <%= appointment.time %></p>
            <p><strong>Status:</strong> <%= appointment.status %></p>
            
            <!-- Enhanced Payment Status Information for History -->
            <% if (appointment.paymentSummary) { %>
              <div class="payment-status-info">
                <h4>Payment Status</h4>
                <div class="payment-summary">
                  <% if (appointment.paymentSummary.totalPaid > 0) { %>
                    <p class="payment-completed">
                      <strong>✓ Paid:</strong> $<%= (appointment.paymentSummary.totalPaid / 100).toFixed(2) %>
                    </p>
                  <% } %>
                  
                  <% if (appointment.paymentSummary.totalPending > 0) { %>
                    <p class="payment-pending">
                      <strong>⏳ Pending:</strong> $<%= (appointment.paymentSummary.totalPending / 100).toFixed(2) %>
                    </p>
                  <% } %>
                  
                  <% if (appointment.paymentSummary.totalFailed > 0) { %>
                    <p class="payment-failed">
                      <strong>❌ Failed:</strong> $<%= (appointment.paymentSummary.totalFailed / 100).toFixed(2) %>
                    </p>
                  <% } %>
                  
                  <!-- Payment Details for History -->
                  <% if (appointment.paymentSummary.paymentDetails && appointment.paymentSummary.paymentDetails.length > 0) { %>
                    <details class="payment-details">
                      <summary>Payment Details</summary>
                      <div class="payment-transactions">
                        <% appointment.paymentSummary.paymentDetails.forEach(payment => { %>
                          <div class="payment-transaction">
                            <p><strong>Type:</strong> <%= payment.type.replace('_', ' ').toUpperCase() %></p>
                            <p><strong>Amount:</strong> $<%= (payment.amount / 100).toFixed(2) %></p>
                            <p><strong>Status:</strong> 
                              <span class="status-<%= payment.status %>"><%= payment.status.toUpperCase() %></span>
                            </p>
                            <% if (payment.square_payment_id) { %>
                              <p><strong>Payment ID:</strong> <%= payment.square_payment_id %></p>
                            <% } %>
                            <% if (payment.error_message) { %>
                              <p class="error-message"><strong>Error:</strong> <%= payment.error_message %></p>
                            <% } %>
                            <p><small>Created: <%= moment(payment.created_at).format('MMM Do, YYYY HH:mm') %></small></p>
                          </div>
                        <% }); %>
                      </div>
                    </details>
                  <% } %>
                </div>
              </div>
            <% } else if (appointment.paymentType && appointment.paymentStatus) { %>
              <div class="payment-info">
                <h4>Payment Information</h4>
                <p><strong>Payment Type:</strong> <%= appointment.paymentType.replace('_', ' ').toUpperCase() %></p>
                <p><strong>Payment Status:</strong> <%= appointment.paymentStatus.replace('_', ' ').toUpperCase() %></p>
                <% if (appointment.totalAmount) { %>
                  <p><strong>Total Amount:</strong> $<%= (appointment.totalAmount / 100).toFixed(2) %></p>
                <% } %>
                <% if (appointment.paidAmount) { %>
                  <p><strong>Amount Paid:</strong> $<%= (appointment.paidAmount / 100).toFixed(2) %></p>
                <% } %>
                <% if (appointment.remainingAmount && appointment.remainingAmount > 0) { %>
                  <p><strong>Remaining Balance:</strong> $<%= (appointment.remainingAmount / 100).toFixed(2) %></p>
                  <% if (appointment.paymentData && appointment.paymentData.invoiceId) { %>
                    <p><strong>Invoice ID:</strong> <%= appointment.paymentData.invoiceId %></p>
                  <% } %>
                <% } %>
                <% if (appointment.paymentData && appointment.paymentData.paymentId) { %>
                  <p><strong>Payment ID:</strong> <%= appointment.paymentData.paymentId %></p>
                <% } %>
              </div>
            <% } else if (appointment.paidAmount) { %>
              <p><strong>Amount Paid:</strong> $<%= (appointment.paidAmount / 100).toFixed(2) %></p>
            <% } %>
          </div>
        <% }); %>
      </div>
    <% } %>
    
  <a href="/dashboard" class="btn btn-secondary">Back to Dashboard</a>
  </div>
</body>
</html>