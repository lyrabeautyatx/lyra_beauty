---
name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Deploy to EC2
        env:
          PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          HOSTNAME: ${{ secrets.EC2_HOST }}
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          echo "$PRIVATE_KEY" | sed 's/\\n/\n/g' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          chmod 700 ~/.ssh

          # Configure SSH client
          cat >> ~/.ssh/config << EOF
          Host production
              HostName $HOSTNAME
              User ec2-user
              IdentityFile ~/.ssh/id_rsa
              StrictHostKeyChecking no
              UserKnownHostsFile /dev/null
          EOF

          # Test SSH connection
          echo "ğŸ”Œ Testing connection to production server..."
          ssh production "echo 'Connection successful'" || {
            echo "âŒ SSH connection failed!"
            exit 1
          }

          # Create deployment package
          echo "ğŸ“¦ Creating deployment package..."
          mkdir deployment

          # Copy application files (exclude development/build artifacts)
          rsync -av \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='*.pem' \
            --exclude='*.log' \
            --exclude='deployment' \
            --exclude='.env' \
            ./ deployment/

          # Create compressed archive
          cd deployment
          tar -czf ../lyra-beauty-deploy.tar.gz .
          cd ..

          echo "âœ… Package created: $(ls -lh lyra-beauty-deploy.tar.gz)"

          # Deploy to production server
          echo "ğŸš€ Deploying to production server..."

          # Upload deployment package
          scp lyra-beauty-deploy.tar.gz production:/tmp/

          # Execute deployment on server
          ssh production << 'DEPLOY_SCRIPT'
          set -e

          echo "ğŸ“ Setting up deployment environment..."

          # Ensure application directory exists
          sudo mkdir -p /opt/lyra-beauty
          sudo chown ec2-user:ec2-user /opt/lyra-beauty
          cd /opt/lyra-beauty

          # Create backup of current version
          if [ -f package.json ]; then
            echo "ğŸ’¾ Creating backup of current version..."
            tar -czf "backup-$(date +%Y%m%d-%H%M%S).tar.gz" \
              --exclude='backup-*.tar.gz' \
              --exclude='node_modules' \
              --exclude='logs/*.log' \
              . || echo "Backup creation failed, continuing..."
          fi

          # Extract new version
          echo "ğŸ“¤ Extracting new application version..."
          tar -xzf /tmp/lyra-beauty-deploy.tar.gz
          rm /tmp/lyra-beauty-deploy.tar.gz

          # Install production dependencies
          echo "ğŸ“¦ Installing production dependencies..."
          npm install --only=production --no-audit

          # Setup environment
          echo "âš™ï¸ Configuring production environment..."
          cat > .env << EOF
          NODE_ENV=production
          PORT=3000
          SESSION_SECRET=lyra_beauty_prod_$(openssl rand -hex 32)
          EOF

          # Ensure logs directory exists
          mkdir -p logs

          # Restart application using PM2 ecosystem
          echo "ğŸ”„ Restarting application with PM2..."

          # Stop existing application gracefully
          pm2 stop lyra-beauty 2>/dev/null || echo "App not running"
          pm2 delete lyra-beauty 2>/dev/null || echo "App not in PM2"

          # Start application using ecosystem configuration
          pm2 start ecosystem.config.js

          # Save PM2 configuration
          pm2 save

          # Verify application is running
          sleep 5
          if pm2 list | grep -q "lyra-beauty.*online"; then
            echo "âœ… Application started successfully!"
          else
            echo "âŒ Application failed to start!"
            pm2 logs lyra-beauty --lines 20
            exit 1
          fi

          echo "ğŸ‰ Deployment completed successfully!"
          public_ip=$(curl -s \
            http://169.254.169.254/latest/meta-data/public-ipv4)
          echo "ğŸŒ Application is available at: http://$public_ip"
          DEPLOY_SCRIPT

          echo "ğŸŠ Deployment finished successfully!"

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/id_rsa
          rm -f lyra-beauty-deploy.tar.gz
          rm -rf deployment

      - name: Deployment Summary
        run: |
          echo "ğŸš€ Deployment Summary"
          echo "====================="
          echo "âœ… Code deployed from main branch"
          echo "âœ… Dependencies installed"
          echo "âœ… Application started with PM2"
          echo "âœ… Environment configured for production"
          echo ""
          echo "ğŸŒ Application URLs:"
          echo "   Primary: http://lyrabeautyatx.com"
          echo "   Direct:  http://${{ secrets.EC2_HOST }}"
